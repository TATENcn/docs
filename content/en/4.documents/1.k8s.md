---
title: kubernetes 技术说明
description: TATEN 服务器集群与容器编排、负载均衡、自动扩缩容等功能的底层技术细节和使用说明。
---

## 一、部署流程

### 1.创建 master 节点

首先，我们需要将一台云服务器作为我们的master节点，安装 kubernetes 组件并初始化集群。
配置 Kubernetes 单机环境

我们登录到准备加入 kubernetes 集群的机器，先设置主机名：

```bash
hostnamectl set-hostname k8s-master
```

然后关闭 swap 分区，这是因为 Kubernetes 要求关闭 swap 以确保性能和稳定性（详情可见 [Swap Off - why is it necessary?](https://discuss.kubernetes.io/t/swap-off-why-is-it-necessary/6879)）：

```bash
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab
```

查看当前 swap 状态（没有输出 swap 大小信息表示 swap 已关闭）：

```bash
swapon --show
# 或
free -h
```

设置内核模块的加载（可参考 [Understanding br_netfilter in the Kubernetes Context](https://architecture-evolution.blogspot.com/2024/07/understanding-brnetfilter-in-kubernetes.html)）：

```bash
# 系统启动时加载 overlay 和 br_netfilter 模块
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
# 立即加载模块
sudo modprobe overlay && sudo modprobe br_netfilter
```

查看内核加载的配置信息：

```bash
# 查看配置信息(应该全部为 1)
sysctl net.bridge.bridge-nf-call-iptables
sysctl net.ipv4.ip_forward
sysctl net.bridge.bridge-nf-call-ip6tables
```

安装容器运行时，这里我们采用 containerd：

```bash
sudo apt update && sudo apt install -y containerd
```

生成 containerd 的默认配置文件，并且设置和 kubernetes 相同的 cgroup 驱动：

```bash
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
```

重启 containerd 服务，并设置开机自启：

```bash
sudo systemctl daemon-reload
sudo systemctl restart containerd
sudo systemctl enable --now containerd
```

安装kubernetes相关组件（kuberadm、kubelet、kubectl）：
可以参考[安装 kubeadm](https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)

```bash
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg
# 如果 `/etc/apt/keyrings` 目录不存在，则应在 curl 命令之前创建它，请阅读下面的注释。
# sudo mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.35/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
sudo chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# 添加合适的 Kubernetes `apt` 仓库。如果你想用 v1.35 之外的 Kubernetes 版本， 请将下面命令中的 v1.35 替换为所需的次要版本：
# 这会覆盖 /etc/apt/sources.list.d/kubernetes.list 中的所有现存配置
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.35/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo chmod 644 /etc/apt/sources.list.d/kubernetes.list   # 有助于让诸如 command-not-found 等工具正常工作

#更新 `apt` 包索引，安装 kubelet、kubeadm 和 kubectl，并锁定其版本：
sudo apt update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

::tip
到这里，上面的内容是 Kubernetes 集群中每个 node 都需要进行的环境配置工作，下面描述 master 节点的配置工作。
::

在 master 节点上，我们使用 kubeadm 工具来初始化集群（详情可以参考[使用 kubeadm 创建集群](https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)）：

```bash
sudo kubeadm init \
    --pod-network-cidr=10.244.0.0/16 \
    --cri-socket=unix:///var/run/containerd/containerd.sock \
    --control-plane-endpoint=hka.server.taten.org:6443
# control-plane-endpoint指定了kube-apiserver监听的IP和端口，这里使用master节点的域名和端口。
# 以上配置仅供参考，以实际情况为准。
```

配置 Kubectl 工具，使 master 节点可以访问集群中的资源。

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

::warning
最好以非 root 用户来执行以上命令，确保 `$HOME/.kube/config` 文件的权限正确设置。
::

到此，master 节点的配置工作已经完成。
